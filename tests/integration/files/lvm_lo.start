#!/bin/bash
[ -n "$DEBUG" ] && [[ $(echo "$DEBUG" | tr '[:upper:]' '[:lower:]') =~ ^y|yes|1|on$ ]] && \
  set -xe || set -e

# also '--pretend' parameter can be used
[ -n "$PRETEND" ] && [[ $(echo "$PRETEND" | tr '[:upper:]' '[:lower:]') =~ ^y|yes|1|on$ ]] && \
  RUN='echo [pretend]' || RUN=""

# Default VG name:
VG_NAME="vg4test_lxc"

STOR_DIR="/var"
STOR_DIR="/root/lxc_ext/faked_storage"

if [ -z "$LOOP_DEV" ] || [ ! -b "$LOOP_DEV" ]; then
  echo "'$LOOP_DEV' is not blockdevice!"
  exit 1
else
  LOOP_DEV="/dev/loop0"
fi

STOR_ISO=${STOR_DIR}/3g.iso
STOR_SIZE_MB=2000
FOUND_IMG=false

function create_iso_image() {
  # create "test block device"
  $RUN dd if=/dev/zero of=${STOR_ISO} bs=1048576 count=${STOR_SIZE_MB}
}

function create_logical_group() {
  $RUN pvcreate ${LOOP_DEV}
  $RUN vgcreate ${VG_NAME} ${LOOP_DEV}
}

if [ ! -f ${STOR_ISO} ]; then
  create_iso_image
else
  echo "Using image file: ${STOR_ISO}"
  FOUND_IMG=true
fi

$RUN losetup ${LOOP_DEV} ${STOR_ISO}

if ! $FOUND_IMG; then
  create_logical_group
fi

exit 0
